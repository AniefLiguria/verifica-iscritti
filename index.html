<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verifica Iscrizione</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-family: sans-serif;
      transition: background 0.5s;
      position: relative; overflow: hidden;
    }
    #logo { position: absolute; top:1em; left:1em; width:80px; }
    #version { position: absolute; bottom:1em; right:1em; color:#555; }
    #loader {
      position: absolute; top:1em; right:1em;
      display:none; align-items:center; color:#555;
    }
    #loader-text { margin-right:.5em; }
    #spinner {
      width:16px; height:16px;
      border:2px solid #ccc; border-top-color:#333;
      border-radius:50%; animation:spin 1s linear infinite;
      display:none;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    #message {
      position:absolute; top:50%; transform:translateY(-50%);
      font-size:2em; color:white; text-align:center;
      text-shadow:0 0 5px rgba(0,0,0,0.5); padding:0 1em;
    }
    #debug {
      position:absolute; bottom:2em; left:1em;
      width:300px; max-height:30%; overflow-y:auto;
      background:rgba(0,0,0,0.7); color:#0f0;
      font-size:.75em; line-height:1.2; padding:.5em;
      display:none; z-index:999;
    }
    video { display:none; }
  </style>
</head>
<body>
  <img id="logo" src="logo.png" alt="Logo ANIEF" onerror="this.style.display='none'">
  <div id="version">v1.3.7</div>

  <div id="loader">
    <span id="loader-text">Caricamento dati… 0%</span>
    <div id="spinner"></div>
  </div>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
  <div id="message">Inquadra un QR code…</div>
  <div id="debug"></div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
  (function(){
    'use strict';

    const DEBUG         = true;
    const APP_VERSION   = 'v1.3.7';
    // Usa qui un URL CSV CORRETTO (pubb. con Google Sheets o su GH Pages)
    const SHEET_CSV_URL = 'iscritti.csv';
    const CACHE_KEY     = 'iscrittiCache';
    const CACHE_VER_KEY = 'iscrittiCacheVer';

    const versionDom  = document.getElementById('version');
    const loader      = document.getElementById('loader');
    const loaderText  = document.getElementById('loader-text');
    const spinner     = document.getElementById('spinner');
    const video       = document.getElementById('video');
    const canvas      = document.getElementById('canvas');
    const ctx         = canvas.getContext('2d');
    const message     = document.getElementById('message');
    const debugPanel  = document.getElementById('debug');

    let iscrittiSet   = null;
    let isProcessing  = false;

    versionDom.textContent = APP_VERSION;

    function debugLog(...args) {
      console.log(...args);
      if (!DEBUG) return;
      debugPanel.style.display = 'block';
      const line = document.createElement('div');
      line.textContent = args.map(a=> typeof a==='string'?a:JSON.stringify(a)).join(' ');
      debugPanel.appendChild(line);
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    function showLoader(on) {
      loader.style.display = on ? 'flex' : 'none';
      if (!on) spinner.style.display = 'none';
    }

    async function initCamera() {
      try {
        const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = s;
        await video.play();
      } catch (e) {
        debugLog('Errore camera', e);
        showError('Impossibile accedere alla fotocamera');
        throw e;
      }
    }

    async function loadSheetData() {
      // cache check
      const v = localStorage.getItem(CACHE_VER_KEY);
      const d = localStorage.getItem(CACHE_KEY);
      if (d && v === APP_VERSION) {
        const arr = JSON.parse(d);
        iscrittiSet = new Set(arr);
        debugLog('Usata cache, size=', iscrittiSet.size, arr.slice(0,10));
        return;
      }

      showLoader(true);
      loaderText.textContent = 'Caricamento dati… 0%';

      try {
        const resp = await fetch(SHEET_CSV_URL);
        if (!resp.ok) throw new Error(resp.status);
        const length = Number(resp.headers.get('content-length'));
        const reader = resp.body.getReader();
        const chunks = [];
        let received = 0;

        const useSpinner = !length;
        if (useSpinner) {
          loaderText.style.display = 'none';
          spinner.style.display = 'block';
        }

        while(true) {
          const {done,value} = await reader.read();
          if (done) break;
          chunks.push(value);
          received += value.length;
          if (length) {
            const pct = Math.round(received/length*100);
            loaderText.textContent = `Caricamento dati… ${pct}%`;
          }
        }

        const buf = new Uint8Array(received);
        let off=0;
        for(const c of chunks){ buf.set(c, off); off+=c.length; }
        const text = new TextDecoder('utf-8').decode(buf);

        const lines = text.trim().split(/\r?\n/).filter(l=>l.trim());
        const hasHeader = lines[0].toUpperCase()==='TESSERA';
        const vals = (hasHeader?lines.slice(1):lines)
                      .map(l=>l.trim().replace(/^\uFEFF/,''));
        debugLog('Parsed count=', vals.length, 'sample=', vals.slice(0,10));

        iscrittiSet = new Set(vals);
        localStorage.setItem(CACHE_KEY, JSON.stringify(vals));
        localStorage.setItem(CACHE_VER_KEY, APP_VERSION);

      } catch(e) {
        debugLog('Errore fetch/parsing', e);
        showError('Errore caricamento CSV');
        throw e;
      } finally {
        loaderText.style.display = '';
        showLoader(false);
      }
    }

    function showResult(found, val) {
      if (found) {
        document.body.style.background = '#2ECC71';
        message.textContent = `ISCRITTO: ${val}`;
      } else {
        document.body.style.background = '#E74C3C';
        message.textContent = 'NON ISCRITTO';
      }
      debugLog('Verifica:', found, val);
    }

    function showError(txt) {
      document.body.style.background = '#555';
      message.textContent = txt;
      debugLog('Error:', txt);
    }

    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width  = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0);
        const img = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(img.data,img.width,img.height,{inversionAttempts:'attemptBoth'});
        if (code && !isProcessing) {
          isProcessing = true;
          handleQR(code.data.trim());
        }
      }
      requestAnimationFrame(tick);
    }

    async function handleQR(raw) {
      debugLog('QR raw:', JSON.stringify(raw));
      try {
        if (!iscrittiSet) await loadSheetData();
        const normalized = raw.replace(/\D/g,''); // se numerico
        const key = iscrittiSet.has(raw) ? raw : (iscrittiSet.has(normalized)?normalized:raw);
        const found = iscrittiSet.has(key);
        showResult(found, key);
      } catch {
        // già mostrato
      } finally {
        setTimeout(()=>{
          isProcessing=false;
          message.textContent='Inquadra un QR code…';
          document.body.style.background=null;
        },5000);
      }
    }

    window.addEventListener('load',async()=>{
      await initCamera();
      requestAnimationFrame(tick);
    });
  })();
  </script>
</body>
</html>
