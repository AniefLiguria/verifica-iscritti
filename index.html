<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verifica Iscrizione</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-family: sans-serif;
      position: relative; overflow: hidden;
      /* Background iniziale: istruzioni */
      background: url('istruzioni.jpg') center/cover no-repeat;
      transition: background-color 0.5s;
    }
    #logo { position:absolute; top:1em; left:1em; width:80px; }
    #version { position:absolute; bottom:1em; right:1em; color:#555; }
    #loader {
      position:absolute; top:1em; right:1em;
      display:none; align-items:center; color:#555;
    }
    #loader-text { margin-right:.5em; }
    #spinner {
      width:16px; height:16px;
      border:2px solid #ccc; border-top-color:#333;
      border-radius:50%; animation:spin 1s linear infinite;
      display:none;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    #message {
      position:absolute; top:50%; transform:translateY(-50%);
      font-size:2em; color:white; text-align:center;
      text-shadow:0 0 5px rgba(0,0,0,0.5); padding:0 1em;
      white-space: pre-line;
    }
    #debug {
      position:absolute; bottom:2em; left:1em;
      width:300px; max-height:30%; overflow-y:auto;
      background:rgba(0,0,0,0.7); color:#0f0;
      font-size:.75em; line-height:1.2; padding:.5em;
      display:none; z-index:999;
    }
    video { display:none; }
  </style>
</head>
<body>
  <img id="logo" src="logo.png" alt="Logo ANIEF" onerror="this.style.display='none'">
  <div id="version">v1.4.0</div>

  <div id="loader">
    <span id="loader-text">Caricamento dati… 0%</span>
    <div id="spinner"></div>
  </div>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
  <div id="message">Inquadra un QR code…</div>
  <div id="debug"></div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
  (function(){
    'use strict';

    const DEBUG         = false;
    const APP_VERSION   = 'v1.4.0';
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvb_6MieMU47M51EmRjlX_AFHSXIFtn0K9PJwGNz2gJYSE0WEMFdgoa7GYwsQsQYYhUHSO-r_RFAvC/pub?gid=1662775114&single=true&output=csv';
    const CACHE_KEY     = 'iscrittiCache';
    const CACHE_VER_KEY = 'iscrittiCacheVer';

    const versionDom = document.getElementById('version');
    const loader     = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const spinner    = document.getElementById('spinner');
    const video      = document.getElementById('video');
    const canvas     = document.getElementById('canvas');
    const ctx        = canvas.getContext('2d');
    const message    = document.getElementById('message');
    const debugPanel = document.getElementById('debug');

    let iscrittiSet  = null;
    let isProcessing = false;

    // Imposta versione
    versionDom.textContent = APP_VERSION;

    function debugLog(...args) {
      console.log(...args);
      if (!DEBUG) return;
      debugPanel.style.display = 'block';
      const line = document.createElement('div');
      line.textContent = args.map(a=> typeof a==='string'?a:JSON.stringify(a)).join(' ');
      debugPanel.appendChild(line);
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    function showLoader(on) {
      loader.style.display = on ? 'flex' : 'none';
      if (!on) spinner.style.display = 'none';
    }

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment'} });
        video.srcObject = stream;
        await video.play();
      } catch (e) {
        debugLog('Errore camera', e);
        showError('Impossibile accedere alla fotocamera');
        throw e;
      }
    }

    async function loadSheetData() {
      const ver = localStorage.getItem(CACHE_VER_KEY);
      const data = localStorage.getItem(CACHE_KEY);
      if (data && ver === APP_VERSION) {
        iscrittiSet = new Set(JSON.parse(data));
        debugLog('Cache usata, elementi=', iscrittiSet.size);
        return;
      }

      showLoader(true);
      loaderText.textContent = 'Caricamento dati… 0%';

      try {
        const resp = await fetch(SHEET_CSV_URL);
        if (!resp.ok) throw new Error(`Status ${resp.status}`);
        debugLog('Fetch CSV OK');

        const length = Number(resp.headers.get('content-length'));
        const reader = resp.body.getReader();
        const chunks = [];
        let received = 0;

        const useSpinner = !length;
        if (useSpinner) {
          loaderText.style.display = 'none';
          spinner.style.display = 'block';
        }

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
          received += value.length;
          if (length) {
            const pct = Math.round(received/length*100);
            loaderText.textContent = `Caricamento dati… ${pct}%`;
          }
        }

        const buf = new Uint8Array(received), dec = new TextDecoder('utf-8');
        let off = 0;
        for (const c of chunks) { buf.set(c, off); off += c.length; }
        const text = dec.decode(buf);

        const lines = text.trim().split(/\r?\n/).filter(l=>l.trim());
        const hasHeader = lines[0].toUpperCase()==='TESSERA';
        const vals = (hasHeader?lines.slice(1):lines).map(l=>l.trim().replace(/^\uFEFF/,''));
        debugLog('Parsed count=', vals.length);

        iscrittiSet = new Set(vals);
        localStorage.setItem(CACHE_KEY, JSON.stringify(vals));
        localStorage.setItem(CACHE_VER_KEY, APP_VERSION);

      } catch (err) {
        debugLog('Errore loadSheetData:', err);
        showError(`Errore CSV: ${err.message}`);
        throw err;
      } finally {
        loaderText.style.display = '';
        showLoader(false);
      }
    }

    function showResult(found, val) {
      // rimuove background-image istruzioni
      document.body.style.backgroundImage = 'none';
      if (found) {
        document.body.style.backgroundColor = '#2ECC71';
        message.textContent = `ISCRITTO\nTessera n. ${val}`;
      } else {
        document.body.style.backgroundColor = '#E74C3C';
        message.textContent = 'NON ISCRITTO';
      }
      debugLog('Verifica:', found, val);
    }

    function showError(txt) {
      document.body.style.backgroundImage = 'none';
      document.body.style.backgroundColor = '#555';
      message.textContent = txt;
      debugLog('Error:', txt);
    }

    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width  = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0);
        const img = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(img.data,img.width,img.height,{inversionAttempts:'attemptBoth'});
        if (code && !isProcessing) {
          isProcessing = true;
          handleQR(code.data.trim());
        }
      }
      requestAnimationFrame(tick);
    }

    async function handleQR(raw) {
      debugLog('QR raw:', raw);
      try {
        if (!iscrittiSet) await loadSheetData();
        const key = raw.trim();
        const found = iscrittiSet.has(key);
        showResult(found, key);
      } catch {
        // già mostrato
      } finally {
        setTimeout(()=>{
          isProcessing=false;
          // ripristina istruzioni
          document.body.style.backgroundImage = `url('istruzioni.png')`;
          document.body.style.backgroundSize = 'cover';
          document.body.style.backgroundPosition = 'center';
          message.textContent = 'Inquadra un QR code…';
        },5000);
      }
    }

    window.addEventListener('load', async ()=>{
      await initCamera();
      requestAnimationFrame(tick);
    });
  })();
  </script>
</body>
</html>
